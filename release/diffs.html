<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Before/After Diff Viewer</title>
  <style>
    :root { --bg:#0b0c10; --panel:#12141a; --text:#e8e8ea; --muted:#a0a4ad; --border:#232633; }
    body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--border); background:rgba(18,20,26,.9); position:sticky; top:0; z-index:2; backdrop-filter: blur(8px); }
    h1 { margin:0; font-size:16px; }
    .row { display:grid; grid-template-columns: 420px 1fr; gap:14px; padding:14px; align-items:start; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .panel h2 { margin:0; padding:10px 12px; font-size:12px; color:var(--muted); border-bottom:1px solid var(--border); letter-spacing:.02em; text-transform:uppercase; }
    textarea { width:100%; min-height:240px; resize:vertical; background:transparent; color:var(--text); border:0; outline:none; padding:12px; font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .controls { display:flex; gap:10px; padding:10px 12px; border-top:1px solid var(--border); align-items:center; flex-wrap:wrap; }
    button { background:#1f2433; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; }
    button:hover { background:#262c3e; }
    label { color:var(--muted); display:flex; gap:6px; align-items:center; }
    input[type="text"] { background:#0f1118; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; width:260px; }
    .out { padding:14px; }
    .card { border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:12px; background:#0f1118; }
    .card .title { padding:10px 12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:10px; }
    .name { font-weight:600; }
    .meta { color:var(--muted); font-size:12px; }
    .diffgrid { display:grid; grid-template-columns: 1fr 1fr; gap:0; }
    .col { padding:10px 12px; }
    .col h3 { margin:0 0 8px 0; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.02em; }
    pre { margin:0; white-space:pre-wrap; word-break:break-word; font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .ins { background:rgba(40, 200, 120, .18); outline:1px solid rgba(40,200,120,.22); border-radius:4px; }
    .del { background:rgba(240, 80, 80, .18); outline:1px solid rgba(240,80,80,.22); border-radius:4px; text-decoration:line-through; }
    .same { }
    .footer-note { color:var(--muted); font-size:12px; padding:0 14px 14px; }
    .hidden { display:none; }
  </style>
</head>
<body>
<header>
  <h1>Before/After Diff Viewer (diff-match-patch)</h1>
</header>

<div class="row">
  <div class="panel">
    <h2>Input JSON</h2>
    <textarea id="jsonInput" spellcheck="false"></textarea>
    <div class="controls">
      <button id="renderBtn">Render diffs</button>
      <button id="loadSampleBtn">Load sample</button>
      <label title="Diff at word level (vs character level)">
        <input id="wordLevel" type="checkbox" checked />
        Word-level
      </label>
      <label title="Apply semantic cleanup (usually nicer)">
        <input id="semantic" type="checkbox" checked />
        Semantic cleanup
      </label>
      <input id="filter" type="text" placeholder="Filter by key (optional)" />
    </div>
  </div>

  <div class="panel">
    <h2>Output</h2>
    <div class="out" id="output"></div>
    <div class="footer-note">
      Notes: strings are treated as <b>text</b> (HTML is escaped) so tags like &lt;b&gt; will show literally.
    </div>
  </div>
</div>

<!-- Diff library (real one) -->
<script src="https://unpkg.com/diff-match-patch@1.0.5/index.js"></script>
<script>
  // --- utilities ---
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  // Optional: make word-level diffs by "tokenizing" text into words/spaces,
  // then joining with a delimiter so diff-match-patch can operate on it.
  // Still uses the library for the diff; this is just a pre-processing step.
  const TOKEN = "\u0001"; // rarely used separator
  function toWordTokens(text) {
    // split into runs of whitespace OR runs of non-whitespace
    const parts = String(text).match(/\s+|[^\s]+/g) || [];
    return parts.join(TOKEN);
  }
  function fromWordTokens(text) {
    return String(text).split(TOKEN).join("");
  }

  function buildBeforeAfterHtml(diffs, mode /* 'previous'|'current' */, wordLevel) {
    // diffs: array of [op, text] where op: -1 delete, 0 equal, +1 insert
    // previous column shows deletions highlighted; current column shows insertions highlighted.
    let html = "";
    for (const [op, raw] of diffs) {
      let piece = raw;
      if (wordLevel) piece = fromWordTokens(piece);

      const safe = escapeHtml(piece);
      if (op === 0) {
        html += `<span class="same">${safe}</span>`;
      } else if (op === -1) {
        html += (mode === "previous")
          ? `<span class="del">${safe}</span>`
          : ""; // deletions not shown in "current" column
      } else if (op === 1) {
        html += (mode === "current")
          ? `<span class="ins">${safe}</span>`
          : ""; // insertions not shown in "previous" column
      }
    }
    return html;
  }

  function render() {
    const out = document.getElementById("output");
    out.innerHTML = "";

    let data;
    try {
      data = JSON.parse(document.getElementById("jsonInput").value);
    } catch (e) {
      out.innerHTML = `<div class="card"><div class="title"><div class="name">Invalid JSON</div></div>
        <div class="col"><pre>${escapeHtml(e.message)}</pre></div></div>`;
      return;
    }

    const filter = document.getElementById("filter").value.trim().toLowerCase();
    const wordLevel = document.getElementById("wordLevel").checked;
    const semantic = document.getElementById("semantic").checked;

    const dmp = new diff_match_patch();
    // Tune these if you want:
    // dmp.Diff_Timeout = 0; // 0 = no timeout (be careful on huge input)
    // dmp.Diff_EditCost = 4;

    const keys = Object.keys(data);
    let shown = 0;

    for (const key of keys) {
      if (filter && !key.toLowerCase().includes(filter)) continue;

      const obj = data[key] || {};
      const prev = obj.previous ?? obj._previous ?? obj.before ?? "";
      const curr = obj._current ?? obj.current ?? obj.after ?? "";

      const a = wordLevel ? toWordTokens(prev) : String(prev);
      const b = wordLevel ? toWordTokens(curr) : String(curr);

      let diffs = dmp.diff_main(a, b);
      if (semantic) dmp.diff_cleanupSemantic(diffs);

      const prevHtml = buildBeforeAfterHtml(diffs, "previous", wordLevel);
      const currHtml = buildBeforeAfterHtml(diffs, "current", wordLevel);

      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = `
        <div>
          <div class="name">${escapeHtml(key)}</div>
          <div class="meta">previous → current</div>
        </div>
        <div class="meta">${escapeHtml((prev.length).toString())} chars → ${escapeHtml((curr.length).toString())} chars</div>
      `;

      const grid = document.createElement("div");
      grid.className = "diffgrid";
      grid.innerHTML = `
        <div class="col">
          <h3>Previous (deletions highlighted)</h3>
          <pre>${prevHtml}</pre>
        </div>
        <div class="col">
          <h3>Current (insertions highlighted)</h3>
          <pre>${currHtml}</pre>
        </div>
      `;

      card.appendChild(title);
      card.appendChild(grid);
      out.appendChild(card);
      shown++;
    }

    if (shown === 0) {
      out.innerHTML = `<div class="card"><div class="title"><div class="name">No matches</div></div>
        <div class="col"><pre>Nothing matched your filter, or the JSON had no keys.</pre></div></div>`;
    }
  }

  document.getElementById("renderBtn").addEventListener("click", render);

  document.getElementById("loadSampleBtn").addEventListener("click", () => {
    const sample = {
      "B.E.S. Big Core MK-3": {
        "_current": "① If your opponent controls a monster and you control no monsters, you can Special Summon this card (from your hand) in Defense Position.\n② If this card is Normal or Special Summoned: Place 3 counters on this card.\n③ Cannot be destroyed by battle.\n④ At the end of the Damage Step, if this card battled: Remove 1 counter from this card.\n⑤ If you cannot, DESTROY it.\nYou can BANISH this card from your GY; shuffle all \"B.E.S.\" monsters from your GY into the Deck.",
        "previous": "① If your opponent controls a monster and you control no monsters, you can Special Summon this card (from your hand) in Defense Position.\n② If this card is Normal or Special Summoned: Place 3 counters on this card.\n③ Cannot be destroyed by battle.\n④ At the end of the Damage Step, if this card battled: Remove 1 counter from this card. If you cannot, DESTROY it.\n⑤ <b>You can BANISH this card from your GY;</b> shuffle all \"B.E.S.\" monsters from your GY into the Deck."
      }
    };
    document.getElementById("jsonInput").value = JSON.stringify(sample, null, 2);
    render();
  });

  // start with sample loaded
  document.getElementById("loadSampleBtn").click();
</script>
</body>
</html>

